// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String      @id
  name          String
  email         String
  emailVerified Boolean     @default(false)
  image         String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  sessions      Session[]
  accounts      Account[]
  userAnimes    UserAnime[]
  reviews       Review[]

  @@unique([email])
  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}

model Anime {
  id            Int      @id
  title         String
  titleEnglish  String?
  titleJapanese String?
  synopsis      String?
  imageUrl      String?
  type          String?
  episodes      Int?
  status        String?
  score         Float?
  rank          Int?
  popularity    Int?
  startDate     String?
  endDate       String?
  season        String?
  year          Int?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  genres      Genre[]
  userEntries UserAnime[]
  reviews     Review[]

  @@index([status])
  @@index([score])
  @@index([year, season])
  @@index([popularity])
  @@map("anime")
}

model Genre {
  id    Int     @id @default(autoincrement())
  name  String  @unique
  anime Anime[]

  @@map("genre")
}

model UserAnime {
  id              String     @id @default(cuid())
  userId          String
  animeId         Int
  status          ListStatus @default(PLAN_TO_WATCH)
  score           Int?
  episodesWatched Int        @default(0)
  startDate       DateTime?
  finishDate      DateTime?
  notes           String?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  anime Anime @relation(fields: [animeId], references: [id], onDelete: Cascade)

  @@unique([userId, animeId])
  @@index([userId])
  @@map("user_anime")
}

model Review {
  id        String   @id @default(cuid())
  userId    String
  animeId   Int
  title     String
  body      String   @db.Text
  rating    Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  anime Anime @relation(fields: [animeId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([animeId])
  @@index([userId, animeId])
  @@map("review")
}

enum ListStatus {
  WATCHING
  COMPLETED
  ON_HOLD
  DROPPED
  PLAN_TO_WATCH
}
